stages:
  - images

.image:
  image: docker:17.12
  stage: images
  services:
    - docker:17.12-dind
  variables:
    DOCKER_DRIVER: overlay2
  tags:
    - docker
    - arm
  script:
    - apk add --no-cache make bash
    - cp binaries/dumb-init dockerfiles/ubuntu/dumb-init
    - chown 0:0 dockerfiles/ubuntu/dumb-init
    - make all

test:
  extends: .image
  script:
    - apk add --no-cache make bash
    - cp binaries/dumb-init dockerfiles/ubuntu/dumb-init
    - chown 0:0 dockerfiles/ubuntu/dumb-init
    - make build
  except:
    - master

runner:
  extends: .image
  only:
    - master
  environment:
    name: stable/docker_images
    url: https://hub.docker.com/r/klud/gitlab-runner/tags/ 
